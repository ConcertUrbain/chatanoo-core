AWSTemplateFormatVersion: 2010-09-09
Description: Chatanoo Core

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Configuration
        Parameters: ["ProjectName", "CreateDNSRecord", "DeploymentBucket"]
      - Label:
          default: Advanced Configuration
        Parameters: ["CoreApplicationKey", "CoreDBSchemaKey"]
      - Label:
          default: DNS Configuration
        Parameters: ["DomainName", "SubDomainName", "VPCId", "EC2KeyName", "Route53HostedZone"]
      - Label:
          default: Custom Resources Configuration
        Parameters: ["PasswordGeneratorLambda", "SQLRequestLambda"]

Parameters:
  ProjectName:
    Type: String
  CreateDNSRecord:
    Type: String
    AllowedValues: ["true", "false"]
    Default: "false"
  DeploymentBucket:
    Description: Name of Chatanoo Deployment Bucket
    Type: String
    Default: chatanoo-deployment

  CoreApplicationKey:
    Type: String
    Default: core/application/1.0.0.zip
  CoreDBSchemaKey:
    Type: String
    Default: core/database/1.0.0.zip

  DomainName:
    Description: Domain Name of the website
    Type: String
  SubDomainName:
    Description: Subdomain Name of the website
    Type: String
  VPCId:
    Description: AWS VPC ID
    Type: AWS::EC2::VPC::Id
  CidrPrefix:
    Type: String
    Default: '10.0.3'
  EC2KeyName:
    Description: EC2 KeyName
    Type: AWS::EC2::KeyPair::KeyName
  Route53HostedZone:
    Description: AWS Route53 HostedZone ID of the domain
    Type: AWS::Route53::HostedZone::Id
  PrivateRouteTable:
    Type: String
  PublicRouteTable:
    Type: String
  InstanceSecurityGroup:
    Type: String
  ResourceSecurityGroup:
    Type: String

  PasswordGeneratorLambda:
    Description: Lambda for the Password Generator Custom Resource
    Type: String
    Default: aws-cloudformation-password-generator-1-0-0"
  SQLRequestLambda:
    Description: Lambda for the SQL Request Custom Resource
    Type: String
    Default: aws-cloudformation-sql-request-1-0-0"

# Mappings

Conditions:
  UseDNSRecord: !Equals [!Ref CreateDNSRecord, "true"]

Resources:

  #############
  # Memcached #
  #############

  MemcachedSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.0/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['0', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano MemcachedSubnet1 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  MemcachedSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MemcachedSubnet1
      RouteTableId: !Ref PrivateRouteTable

  MemcachedSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.32/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['1', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano MemcachedSubnet2 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  MemcachedSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MemcachedSubnet2
      RouteTableId: !Ref PrivateRouteTable

  MemcachedNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano MemcachedNetworkAcl (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  InboundMemcachedNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MemcachedNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.128/26" # CoreSubnets Cidr
      PortRange:
        From: 11211
        To: 11211

  InboundEmphemeralMemcachedNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MemcachedNetworkAcl
      RuleNumber: 200
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.128/26" # CoreSubnets Cidr
      PortRange:
        From: 1024
        To: 65535

  OutboundMemcachedNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MemcachedNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 0
        To: 65535

  MemcachedSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref MemcachedSubnet1
      NetworkAclId: !Ref MemcachedNetworkAcl

  MemcachedSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref MemcachedSubnet2
      NetworkAclId: !Ref MemcachedNetworkAcl

  MemcachedClientSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Chatanoo Memcached Client SecurityGroup
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano MemcachedClientSecurityGroup (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  MemcachedClusterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Chatanoo Memcached Cluster SecurityGroup
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano MemcachedClusterSecurityGroup (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  MemcachedClusterIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MemcachedClusterSecurityGroup
      IpProtocol: tcp
      ToPort: 11211
      FromPort: 11211
      SourceSecurityGroupId: !Ref MemcachedClientSecurityGroup

  MemcachedParameters:
    Type: AWS::ElastiCache::ParameterGroup
    Properties:
      Description: Chatanoo memcached params
      CacheParameterGroupFamily: memcached1.4
      Properties:
        cas_disabled: '1'

  MemcachedSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Chatanoo memcached subnet group
      SubnetIds:
        - !Ref MemcachedSubnet1
        - !Ref MemcachedSubnet2

  MemcachedCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      AZMode: single-az
      CacheNodeType: cache.t2.micro
      Port: '11211'
      CacheParameterGroupName: !Ref MemcachedParameters
      VpcSecurityGroupIds:
        - !Ref MemcachedClusterSecurityGroup
      CacheSubnetGroupName: !Ref MemcachedSubnetGroup
      Engine: memcached
      EngineVersion: 1.4.14
      NumCacheNodes: '1'
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  #######
  # RDS #
  #######

  RDSSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.64/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['0', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano RDSSubnet1 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RDSSubnet1
      RouteTableId: !Ref PrivateRouteTable

  RDSSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.96/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['1', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano RDSSubnet2 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RDSSubnet2
      RouteTableId: !Ref PrivateRouteTable

  RDSNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano RDSNetworkAcl (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  InboundRDSNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref RDSNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.128/26" # CoreSubnets Cidr
      PortRange:
        From: 3306
        To: 3306

  InboundEmphemeralRDSNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref RDSNetworkAcl
      RuleNumber: 200
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.128/26" # CoreSubnets Cidr
      PortRange:
        From: 1024
        To: 65535

  OutboundRDSNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref RDSNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 0
        To: 65535

  RDSSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref RDSSubnet1
      NetworkAclId: !Ref RDSNetworkAcl

  RDSSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref RDSSubnet2
      NetworkAclId: !Ref RDSNetworkAcl

  RDSSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: Chatano RDS SubnetGroup
      SubnetIds:
        - !Ref RDSSubnet1
        - !Ref RDSSubnet2
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSClientSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Chatanoo RDS Client SecurityGroup
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano RDSClientSecurityGroup (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Chatanoo RDS Cluster SecurityGroup
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano RDSInstanceSecurityGroup (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSInstanceIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RDSInstanceSecurityGroup
      IpProtocol: tcp
      ToPort: 3306
      FromPort: 3306
      SourceSecurityGroupId: !Ref RDSClientSecurityGroup

  RDSLambdaResourceIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RDSInstanceSecurityGroup
      IpProtocol: tcp
      ToPort: 3306
      FromPort: 3306
      SourceSecurityGroupId: !Ref ResourceSecurityGroup

  RDSDBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Chatanoo RDS ParameterGroup
      Family: mysql5.6
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  RDSDBOptionGroup:
    Type: AWS::RDS::OptionGroup
    Properties:
      EngineName: mysql
      MajorEngineVersion: 5.6
      OptionGroupDescription: Chatanoo RDS OptionGroup
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  DBUsername:
    Type: Custom::Password
    Version: 1.0
    Properties:
      ServiceToken: !Join [":", ["arn:aws:lambda", !Ref 'AWS::Region', !Ref 'AWS::AccountId', "function", !Ref PasswordGeneratorLambda]]
      Memorable: true

  DBPassword:
    Type: Custom::Password
    Version: 1.0
    Properties:
      ServiceToken: !Join [":", ["arn:aws:lambda", !Ref 'AWS::Region', !Ref 'AWS::AccountId', "function", !Ref PasswordGeneratorLambda]]
      Strong: true

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: 5
      AutoMinorVersionUpgrade: true
      AvailabilityZone: !Select ['0', !GetAZs { Ref: 'AWS::Region'}]
      BackupRetentionPeriod: 7
      DBInstanceClass: db.t2.micro
      DBParameterGroupName: !Ref RDSDBParameterGroup
      DBSubnetGroupName: !Ref RDSSubnetGroup
      Engine: mysql
      EngineVersion: 5.6.22
      DBName: chatanoo
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      MultiAZ: false
      OptionGroupName: !Ref RDSDBOptionGroup
      Port: '3306'
      PubliclyAccessible: false
      StorageEncrypted: false
      StorageType: standard
      VPCSecurityGroups:
        - !Ref RDSInstanceSecurityGroup
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  DatabaseSchema:
    Type: Custom::SQLRequest
    Version: 1.0
    Properties:
      ServiceToken: !Join [":", ["arn:aws:lambda", !Ref 'AWS::Region', !Ref 'AWS::AccountId', "function", !Ref SQLRequestLambda]]
      Host: !GetAtt RDSInstance.Endpoint.Address
      Port: !GetAtt RDSInstance.Endpoint.Port
      User: !Ref DBUsername
      Password: !Ref DBPassword
      Database: chatanoo
      Engine: mysql
      Request:
        Bucket: !Ref DeploymentBucket
        Key: !Ref CoreDBSchemaKey

  ###############
  # Application #
  ###############

  CoreSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.128/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['0', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano CoreSubnet1 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  CoreSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref CoreSubnet1
      RouteTableId: !Ref PrivateRouteTable

  CoreSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.160/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['1', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano CoreSubnet2 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  CoreSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref CoreSubnet2
      RouteTableId: !Ref PrivateRouteTable

  CoreNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano CoreNetworkAcl (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  InboundHTTPCoreNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CoreNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.192/26" # CorePublicSubnets Cidr
      PortRange:
        From: 80
        To: 80

  InboundHTTPSCoreNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CoreNetworkAcl
      RuleNumber: 101
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: !Sub "${CidrPrefix}.192/26" # CorePublicSubnets Cidr
      PortRange:
        From: 443
        To: 443

  InboundEmphemeralCoreNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CoreNetworkAcl
      RuleNumber: 201
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  OutboundCoreNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CoreNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 0
        To: 65535

  CoreSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref CoreSubnet1
      NetworkAclId: !Ref CoreNetworkAcl

  CoreSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref CoreSubnet2
      NetworkAclId: !Ref CoreNetworkAcl

  CorePublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.192/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['0', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano CorePublicSubnet1 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  CorePublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref CorePublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  CorePublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: !Sub "${CidrPrefix}.224/27"
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select ['1', !GetAZs { Ref: 'AWS::Region'}]
      Tags:
        - Key: Name
          Value: !Sub "Chatano CorePublicSubnet2 (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  CorePublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref CorePublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  CorePublicNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "Chatano CorePublicNetworkAcl (${ProjectName})"
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  InboundHTTPCorePublicNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CorePublicNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 80
        To: 80

  InboundHTTPSCorePublicNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CorePublicNetworkAcl
      RuleNumber: 101
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 443
        To: 443

  InboundEmphemeralCorePublicNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CorePublicNetworkAcl
      RuleNumber: 201
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  OutboundCorePublicNetworkAclEntry:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref CorePublicNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 0
        To: 65535

  CorePublicSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref CorePublicSubnet1
      NetworkAclId: !Ref CorePublicNetworkAcl

  CorePublicSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref CorePublicSubnet2
      NetworkAclId: !Ref CorePublicNetworkAcl

  CoreEBInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/"
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: BucketAccess
                Effect: Allow
                Action:
                  - s3:Get*
                  - s3:List*
                  - s3:PutObject
                Resource:
                  - arn:aws:s3:::elasticbeanstalk-*
                  - arn:aws:s3:::elasticbeanstalk-*/*

  CoreEBEC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - !Ref CoreEBInstanceRole

  CoreEBRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - elasticbeanstalk.amazonaws.com
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: elasticbeanstalk
      Path: "/"
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: HealthReporting
                Effect: Allow
                Action:
                  - elasticloadbalancing:DescribeInstanceHealth
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:GetConsoleOutput
                  - ec2:AssociateAddress
                  - ec2:DescribeAddresses
                  - ec2:DescribeSecurityGroups
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                  - autoscaling:DescribeScalingActivities
                  - autoscaling:DescribeNotificationConfigurations
                Resource:
                  - '*'
              - Sid: AllowOperations
                Effect: Allow
                Action:
                  - autoscaling:AttachInstances
                  - autoscaling:CreateAutoScalingGroup
                  - autoscaling:CreateLaunchConfiguration
                  - autoscaling:DeleteLaunchConfiguration
                  - autoscaling:DeleteAutoScalingGroup
                  - autoscaling:DeleteScheduledAction
                  - autoscaling:DescribeAccountLimits
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                  - autoscaling:DescribeLaunchConfigurations
                  - autoscaling:DescribeLoadBalancers
                  - autoscaling:DescribeNotificationConfigurations
                  - autoscaling:DescribeScalingActivities
                  - autoscaling:DescribeScheduledActions
                  - autoscaling:DetachInstances
                  - autoscaling:PutScheduledUpdateGroupAction
                  - autoscaling:ResumeProcesses
                  - autoscaling:SetDesiredCapacity
                  - autoscaling:SuspendProcesses
                  - autoscaling:TerminateInstanceInAutoScalingGroup
                  - autoscaling:UpdateAutoScalingGroup
                  - cloudwatch:PutMetricAlarm
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:CreateSecurityGroup
                  - ec2:DeleteSecurityGroup
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeImages
                  - ec2:DescribeInstances
                  - ec2:DescribeKeyPairs
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:TerminateInstances
                  - ecs:CreateCluster
                  - ecs:DeleteCluster
                  - ecs:DescribeClusters
                  - ecs:RegisterTaskDefinition
                  - elasticbeanstalk:*
                  - elasticloadbalancing:ApplySecurityGroupsToLoadBalancer
                  - elasticloadbalancing:ConfigureHealthCheck
                  - elasticloadbalancing:CreateLoadBalancer
                  - elasticloadbalancing:DeleteLoadBalancer
                  - elasticloadbalancing:DeregisterInstancesFromLoadBalancer
                  - elasticloadbalancing:DescribeInstanceHealth
                  - elasticloadbalancing:DescribeLoadBalancers
                  - elasticloadbalancing:DescribeTargetHealth
                  - elasticloadbalancing:RegisterInstancesWithLoadBalancer
                  - iam:ListRoles
                  - iam:PassRole
                  - logs:CreateLogGroup
                  - logs:PutRetentionPolicy
                  - rds:DescribeDBInstances
                  - rds:DescribeOrderableDBInstanceOptions
                  - s3:CopyObject
                  - s3:GetObject
                  - s3:GetObjectAcl
                  - s3:GetObjectMetadata
                  - s3:ListBucket
                  - s3:listBuckets
                  - s3:ListObjects
                  - sns:CreateTopic
                  - sns:GetTopicAttributes
                  - sns:ListSubscriptionsByTopic
                  - sns:Subscribe
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource:
                  - "*"
              - Sid: AllowS3OperationsOnElasticBeanstalkBuckets
                Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - arn:aws:s3:::elasticbeanstalk-*
                  - arn:aws:s3:::elasticbeanstalk-*/*
              - Sid: AllowCloudformationOperationsOnElasticBeanstalkStacks
                Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - arn:aws:cloudformation:*:*:stack/awseb-*
                  - arn:aws:cloudformation:*:*:stack/eb-*

  CoreApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      Description: Chatanoo Core

  CoreApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    Properties:
      ApplicationName: !Ref CoreApplication
      Description: Chatanoo Core Application Version
      SourceBundle:
        S3Bucket: !Ref DeploymentBucket
        S3Key: !Ref CoreApplicationKey

  CoreConfigurationTemplate:
    Type: AWS::ElasticBeanstalk::ConfigurationTemplate
    Properties:
      ApplicationName: !Ref CoreApplication
      Description: Chatanoo Core Configuration Template
      SolutionStackName: 64bit Amazon Linux 2016.03 v2.1.7 running PHP 5.6
      OptionSettings:
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: LoadBalanced
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Ref CoreEBRole
        - Namespace: aws:autoscaling:asg
          OptionName: MinSize
          Value: '1'
        - Namespace: aws:autoscaling:asg
          OptionName: MaxSize
          Value: '1'

        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: EC2KeyName
          Value: !Ref EC2KeyName
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: InstanceType
          Value: t1.micro
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !GetAtt CoreEBEC2InstanceProfile.Arn
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: SecurityGroups
          Value: !Join [',', [!Ref MemcachedClientSecurityGroup, !Ref RDSClientSecurityGroup, !Ref InstanceSecurityGroup]]
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value: !Ref VPCId
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value: !Join [',', [!Ref CoreSubnet1, !Ref CoreSubnet2]]
        - Namespace: aws:ec2:vpc
          OptionName: ELBSubnets
          Value: !Join [',', [!Ref CorePublicSubnet1, !Ref CorePublicSubnet2]]
        - Namespace: aws:elasticbeanstalk:healthreporting:system
          OptionName: SystemType
          Value: enhanced
        - Namespace: aws:elasticbeanstalk:healthreporting:system
          OptionName: ConfigDocument
          Value: |
            {
              "CloudWatchMetrics": {
                "Environment": {
                  "InstancesSevere": 60,
                  "ApplicationLatencyP90": 60,
                  "ApplicationLatencyP99": 60,
                  "ApplicationLatencyP95": 60,
                  "InstancesUnknown": 60,
                  "ApplicationLatencyP85": 60,
                  "InstancesInfo": 60,
                  "ApplicationRequests2xx": 60,
                  "InstancesDegraded": 60,
                  "InstancesWarning": 60,
                  "ApplicationLatencyP50": 60,
                  "ApplicationRequestsTotal": 60,
                  "InstancesNoData": 60,
                  "InstancesPending": 60,
                  "ApplicationLatencyP10": 60,
                  "ApplicationRequests5xx": 60,
                  "ApplicationLatencyP75": 60,
                  "InstancesOk": 60,
                  "ApplicationRequests3xx": 60,
                  "ApplicationRequests4xx": 60
              },
              "Instance": {
                  "ApplicationLatencyP90": 60,
                  "ApplicationLatencyP99": 60,
                  "ApplicationLatencyP95": 60,
                  "ApplicationLatencyP85": 60,
                  "CPUUser": 60,
                  "ApplicationRequests2xx": 60,
                  "CPUIdle": 60,
                  "ApplicationLatencyP50": 60,
                  "ApplicationRequestsTotal": 60,
                  "RootFilesystemUtil": 60,
                  "LoadAverage1min": 60,
                  "CPUIrq": 60,
                  "CPUNice": 60,
                  "CPUIowait": 60,
                  "ApplicationLatencyP10": 60,
                  "LoadAverage5min": 60,
                  "ApplicationRequests5xx": 60,
                  "ApplicationLatencyP75": 60,
                  "CPUSystem": 60,
                  "ApplicationRequests3xx": 60,
                  "ApplicationRequests4xx": 60,
                  "InstanceHealth": 60,
                  "CPUSoftirq": 60
                }
              },
              "Version": 1
            }

        - !If
          - UseDNSRecord
          - Namespace: aws:elb:listener:443
            OptionName: ListenerProtocol
            Value: HTTPS
          - Namespace: aws:elb:listener
            OptionName: ListenerProtocol
            Value: HTTP
        - !If
          - UseDNSRecord
          - Namespace: aws:elb:listener:443
            OptionName: SSLCertificateId
            Value: !Ref Certificate
          - !Ref 'AWS::NoValue'
        - !If
          - UseDNSRecord
          - Namespace: aws:elb:listener:443
            OptionName: InstancePort
            Value: 80
          - Namespace: aws:elb:listener
            OptionName: InstancePort
            Value: 80
        - !If
          - UseDNSRecord
          - Namespace: aws:elb:listener:443
            OptionName: InstanceProtocol
            Value: HTTP
          - Namespace: aws:elb:listener
            OptionName: InstanceProtocol
            Value: HTTP

        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: APPLICATION_ENV
          Value: production
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: DATABASE_HOST
          Value: !GetAtt RDSInstance.Endpoint.Address
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: DATABASE_NAME
          Value: chatanoo
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: DATABASE_PASS
          Value: !Ref DBPassword
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: DATABASE_USER
          Value: !Ref DBUsername
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: MEMCACHED_HOST
          Value: !GetAtt MemcachedCluster.ConfigurationEndpoint.Address
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: MEMCACHED_PORT
          Value: !GetAtt MemcachedCluster.ConfigurationEndpoint.Port

  CoreEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref CoreApplication
      Description: Chatanoo Core Environment
      TemplateName: !Ref CoreConfigurationTemplate
      VersionLabel: !Ref CoreApplicationVersion
      Tags:
        - Key: chatanoo:project
          Value: !Ref ProjectName
        - Key: chatanoo:component
          Value: core

  CoreDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref Route53HostedZone
      Comment: !Join [' - ', [!Ref ProjectName, Public DNS Record for Core]]
      Name: !Join ['', [!Ref SubDomainName, '.', !Ref DomainName, '.']]
      Type: CNAME
      TTL: '300'
      ResourceRecords:
        - !GetAtt CoreEnvironment.EndpointURL
    Condition: UseDNSRecord

  Certificate:
    Type: "AWS::CertificateManager::Certificate"
    Condition: UseDNSRecord
    Properties:
      DomainName: !Join ['.', [!Ref SubDomainName, !Ref DomainName]]
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          ValidationDomain: !Ref DomainName
      SubjectAlternativeNames:
        - !Ref DomainName
      Tags:
        - Resource Tag

Outputs:
  Url:
    Value: !If
      - UseDNSRecord
      - !Join ['', ['https://', !Ref SubDomainName, '.', !Ref DomainName]]
      - !Join ['', ['http://', !GetAtt CoreEnvironment.EndpointURL]]
